# Kubernetes Monitoring Tools Documentation

## Table of Contents

- [Overview](#overview)
- [Architecture](#architecture)
- [Components](#components)
  - [Prometheus](#prometheus)
  - [Grafana](#grafana)
  - [Jaeger](#jaeger)
  - [Alertmanager](#alertmanager)
- [Deployment](#deployment)
  - [Prerequisites](#prerequisites)
  - [Deploy Monitoring Tools](#deploy-monitoring-tools)
    - [Using Helm](#using-helm)
    - [Using Kubernetes Manifests](#using-kubernetes-manifests)
- [Configuration](#configuration)
  - [Prometheus Configuration](#prometheus-configuration)
  - [Grafana Configuration](#grafana-configuration)
  - [Jaeger Configuration](#jaeger-configuration)
  - [Alertmanager Configuration](#alertmanager-configuration)
- [Monitoring](#monitoring)
  - [Dashboards and Visualizations](#dashboards-and-visualizations)
  - [Alerting](#alerting)
  - [Tracing](#tracing)
- [Security](#security)
  - [Access Control](#access-control)
  - [Secure Communication](#secure-communication)
  - [Data Protection](#data-protection)
- [Troubleshooting](#troubleshooting)
  - [Common Issues](#common-issues)
  - [Debugging Steps](#debugging-steps)
- [Further Reading](#further-reading)
- [Links](#links)

---

## Overview

The **Kubernetes Monitoring Tools** component provides comprehensive observability for the Laboratory Swarm Application. It leverages industry-standard tools to collect, store, visualize, and alert on metrics, logs, and traces generated by the application's microservices. The primary tools included in this component are:

- **Prometheus**: Metrics collection and storage.
- **Grafana**: Metrics visualization through customizable dashboards.
- **Jaeger**: Distributed tracing for performance monitoring.
- **Alertmanager**: Alert handling and routing based on Prometheus alerts.

These tools work in concert to ensure that the application's performance, reliability, and security are continuously monitored and maintained.

## Architecture

![Kubernetes Monitoring Tools Architecture](./architecture.png)

*Figure: High-level architecture of the Kubernetes Monitoring Tools component.*

The monitoring stack operates within the `monitoring` namespace in the Kubernetes cluster. Prometheus scrapes metrics from various services and stores them, Grafana visualizes these metrics, Jaeger collects and analyzes traces, and Alertmanager manages alerts based on Prometheus' alerting rules. This architecture ensures seamless integration and efficient monitoring of the Laboratory Swarm Application.

## Components

### Prometheus

**Prometheus** is an open-source systems monitoring and alerting toolkit. It collects metrics from configured targets at given intervals, evaluates rule expressions, displays results, and can trigger alerts if certain conditions are met.

- **Key Features**:
  - Multi-dimensional data model with time series data identified by metric name and key/value pairs.
  - Powerful query language (PromQL) for slicing and dicing collected time series data.
  - Targets discovered via service discovery or static configuration.
  - Pushing time series via an intermediary gateway.

- **File**: `kubernetes/prometheus-deployment.yaml`

### Grafana

**Grafana** is an open-source platform for monitoring and observability. It provides dashboards and graphs for visualizing metrics collected by Prometheus and other data sources.

- **Key Features**:
  - Highly customizable dashboards.
  - Support for multiple data sources, including Prometheus, Elasticsearch, and more.
  - Alerting capabilities integrated with various notification channels.
  - Plugin architecture for extended functionality.

- **File**: `kubernetes/grafana-deployment.yaml`

### Jaeger

**Jaeger** is an open-source, end-to-end distributed tracing tool. It is used for monitoring and troubleshooting transactions in complex distributed systems.

- **Key Features**:
  - Distributed context propagation for tracing.
  - Root cause analysis for latency and performance issues.
  - Service dependency analysis.
  - Adaptive sampling for efficient data collection.

- **File**: `kubernetes/jaeger-deployment.yaml`

### Alertmanager

**Alertmanager** handles alerts sent by client applications like Prometheus. It manages alert deduplication, grouping, and routing to various receivers such as email, Slack, or PagerDuty.

- **Key Features**:
  - Silencing of alerts based on specific criteria.
  - Inhibition to mute alerts in response to other alerts.
  - Multiple notification receivers.
  - Integration with various communication channels.

- **File**: `kubernetes/alertmanager-deployment.yaml`

## Deployment

### Prerequisites

Before deploying the Kubernetes Monitoring Tools, ensure the following prerequisites are met:

- **Kubernetes Cluster**: A functional Kubernetes cluster (v1.18+).
- **Kubectl**: The Kubernetes command-line tool is installed and configured.
- **Helm**: (Optional) Helm package manager is installed for easier deployment.
- **Namespace**: Create a dedicated `monitoring` namespace for isolation.
  
  ```bash
  kubectl create namespace monitoring
  ```

### Deploy Monitoring Tools

You can deploy the monitoring tools using **Helm** charts or **Kubernetes manifests**. Below are the steps for both methods.

#### Using Helm

Helm simplifies the deployment of complex applications by using charts, which are packages of pre-configured Kubernetes resources.

1. **Add Helm Repositories**

   Add the official Helm repositories for Prometheus, Grafana, and Jaeger.

   ```bash
   helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
   helm repo add grafana https://grafana.github.io/helm-charts
   helm repo add jaegertracing https://jaegertracing.github.io/helm-charts
   helm repo update
   ```

2. **Install Prometheus**

   ```bash
   helm install prometheus prometheus-community/kube-prometheus-stack \
     --namespace monitoring \
     --create-namespace
   ```

3. **Install Grafana**

   (Note: Grafana is included in the `kube-prometheus-stack` chart. If you prefer a separate installation, proceed as follows.)

   ```bash
   helm install grafana grafana/grafana \
     --namespace monitoring \
     --set adminPassword='YourSecurePassword' \
     --set persistence.enabled=true \
     --set persistence.size=10Gi
   ```

4. **Install Jaeger**

   ```bash
   helm install jaeger jaegertracing/jaeger \
     --namespace monitoring \
     --set collector.replicas=2 \
     --set query.replicas=2 \
     --set storage.type=memory
   ```

5. **Install Alertmanager**

   (Note: Alertmanager is included in the `kube-prometheus-stack` chart. If you prefer a separate installation, proceed as follows.)

   ```bash
   helm install alertmanager prometheus-community/prometheus-alertmanager \
     --namespace monitoring
   ```

#### Using Kubernetes Manifests

Alternatively, deploy the monitoring tools using Kubernetes manifests.

1. **Navigate to the Kubernetes Configuration Directory**

   ```bash
   cd infrastructure/kubernetes
   ```

2. **Deploy Prometheus**

   ```bash
   kubectl apply -f prometheus-deployment.yaml
   ```

3. **Deploy Grafana**

   ```bash
   kubectl apply -f grafana-deployment.yaml
   ```

4. **Deploy Jaeger**

   ```bash
   kubectl apply -f jaeger-deployment.yaml
   ```

5. **Deploy Alertmanager**

   ```bash
   kubectl apply -f alertmanager-deployment.yaml
   ```

6. **Verify the Deployment**

   ```bash
   kubectl get all -n monitoring
   ```

   Ensure that all pods are in the `Running` state without errors.

## Configuration

### Prometheus Configuration

Prometheus requires configuration to specify which metrics to scrape and how to handle alerting rules.

- **File**: `kubernetes/prometheus-config.yaml`

  ```yaml
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: prometheus-config
    namespace: monitoring
  data:
    prometheus.yml: |
      global:
        scrape_interval: 15s
        evaluation_interval: 15s
      scrape_configs:
        - job_name: 'kubernetes-apiservers'
          kubernetes_sd_configs:
            - role: endpoints
          scheme: https
          tls_config:
            ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            insecure_skip_verify: true
          bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
          relabel_configs:
            - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
              action: keep
              regex: default;kubernetes;https
      alerting:
        alertmanagers:
          - static_configs:
              - targets: ['alertmanager.monitoring.svc.cluster.local:9093']
      rule_files:
        - /etc/prometheus/rules/*.yaml
  ```

- **Alerting Rules**

  Define alerting rules in separate YAML files and place them in `/etc/prometheus/rules/`.

  **Example**: `kubernetes/prometheus-rules.yaml`

  ```yaml
  groups:
    - name: example-alerts
      rules:
        - alert: HighCPUUsage
          expr: sum(rate(container_cpu_usage_seconds_total{namespace="laboratory-swarm"}[1m])) by (pod) > 0.8
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage detected for pod {{ $labels.pod }}"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is using more than 80% CPU for the last 2 minutes."
  ```

### Grafana Configuration

Grafana requires configuration for data sources and dashboards.

- **Data Source**

  Prometheus is configured as a data source in Grafana.

  - **File**: `kubernetes/grafana-datasource.yaml`

    ```yaml
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus.monitoring.svc.cluster.local:9090
        isDefault: true
    ```

- **Dashboards**

  Import pre-built dashboards or create custom dashboards tailored to the Laboratory Swarm Application.

  - **File**: `kubernetes/grafana-dashboards.yaml`

    ```yaml
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        options:
          path: /var/lib/grafana/dashboards
    ```

  - **Dashboard Files**

    Place JSON dashboard files in `/var/lib/grafana/dashboards/`.

### Jaeger Configuration

Jaeger requires configuration for collector, query, and storage backend.

- **Collector Configuration**

  - **File**: `kubernetes/jaeger-collector-config.yaml`

    ```yaml
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: jaeger-collector-config
      namespace: monitoring
    data:
      collector.yaml: |
        receivers:
          otlp:
            protocols:
              grpc:
              http:
        processors:
          batch:
        exporters:
          logging:
            loglevel: debug
          jaeger:
            endpoint: jaeger-collector.monitoring.svc.cluster.local:14250
        service:
          pipelines:
            traces:
              receivers: [otlp]
              processors: [batch]
              exporters: [logging, jaeger]
    ```

### Alertmanager Configuration

Alertmanager requires configuration for routing and notification receivers.

- **File**: `kubernetes/alertmanager-config.yaml`

  ```yaml
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: alertmanager-config
    namespace: monitoring
  data:
    alertmanager.yml: |
      global:
        resolve_timeout: 5m
      route:
        group_by: ['alertname']
        group_wait: 10s
        group_interval: 10m
        repeat_interval: 1h
        receiver: 'slack-notifications'
      receivers:
        - name: 'slack-notifications'
          slack_configs:
            - api_url: 'https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX'
              channel: '#alerts'
    ```

  **Note**: Replace the `api_url` with your actual Slack webhook URL or configure other receivers as needed.

## Monitoring

### Dashboards and Visualizations

Utilize Grafana to create and manage dashboards that provide insights into the application's performance and health.

- **Prometheus Metrics**: Visualize metrics collected by Prometheus, such as CPU usage, memory consumption, request rates, and error rates.
- **Jaeger Traces**: Analyze distributed traces to identify latency bottlenecks and understand request flows.
- **Custom Dashboards**: Create dashboards tailored to specific needs, such as monitoring drone telemetry data or aggregator API performance.

**Example Dashboards**:

1. **System Overview**: High-level metrics on cluster performance.
2. **Service Performance**: Detailed metrics for each microservice.
3. **Alert Dashboard**: Overview of active and resolved alerts.
4. **Tracing Dashboard**: Visualization of traces collected by Jaeger.

### Alerting

Set up alerting rules in Prometheus to notify you of critical issues.

- **High CPU Usage**: Alert when CPU usage exceeds a defined threshold.
- **High Memory Consumption**: Alert when memory usage is too high.
- **Service Unavailability**: Alert when a service becomes unreachable.
- **Error Rates**: Alert on increasing error rates indicating potential issues.

**Example Alert Rules**:

```yaml
groups:
  - name: example-alerts
    rules:
      - alert: HighCPUUsage
        expr: sum(rate(container_cpu_usage_seconds_total{namespace="laboratory-swarm"}[1m])) by (pod) > 0.8
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage detected for pod {{ $labels.pod }}"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is using more than 80% CPU for the last 2 minutes."
```

### Tracing

Use Jaeger to perform distributed tracing across microservices, allowing you to track requests as they propagate through the system.

- **Trace Collection**: Instrument services to send trace data to Jaeger.
- **Trace Analysis**: Identify performance bottlenecks, latency issues, and service dependencies.
- **Root Cause Analysis**: Quickly determine the source of failures or degraded performance.

## Security

### Access Control

Implement strict access controls to ensure that only authorized personnel can access and modify the monitoring tools.

- **Kubernetes RBAC**: Define roles and role bindings to restrict access to monitoring namespaces and resources.
  
  **Example RBAC Configuration**:

  ```yaml
  apiVersion: rbac.authorization.k8s.io/v1
  kind: Role
  metadata:
    namespace: monitoring
    name: monitoring-viewer
  rules:
    - apiGroups: [""]
      resources: ["pods", "services", "endpoints", "configmaps"]
      verbs: ["get", "list", "watch"]
    - apiGroups: ["apps"]
      resources: ["deployments", "statefulsets"]
      verbs: ["get", "list", "watch"]
  ---
  apiVersion: rbac.authorization.k8s.io/v1
  kind: RoleBinding
  metadata:
    name: monitoring-viewer-binding
    namespace: monitoring
  subjects:
    - kind: User
      name: "jane.doe@example.com"
      apiGroup: rbac.authorization.k8s.io
  roleRef:
    kind: Role
    name: monitoring-viewer
    apiGroup: rbac.authorization.k8s.io
  ```

### Secure Communication

Ensure that all communication between monitoring tools and the Kubernetes cluster is encrypted and authenticated.

- **TLS Encryption**: Use TLS to encrypt data in transit. Configure Prometheus, Grafana, Jaeger, and Alertmanager to use TLS for their endpoints.
- **Authentication**: Implement authentication mechanisms for accessing Grafana dashboards and Jaeger UI.

### Data Protection

Protect sensitive monitoring data through proper storage and access controls.

- **Persistent Storage**: Use persistent volumes for Prometheus and Grafana to ensure data durability.
- **Backup and Recovery**: Implement backup strategies for critical monitoring data to prevent data loss.
- **Data Retention Policies**: Define data retention policies to manage storage usage and comply with organizational requirements.

## Troubleshooting

### Common Issues

1. **Prometheus Not Scraping Metrics**

   - **Symptoms**: Missing metrics, Grafana dashboards showing incomplete data.
   - **Solutions**:
     - Verify Prometheus scrape configurations.
     - Ensure that targets are up and reachable.
     - Check Prometheus logs for scraping errors.
   
2. **Grafana Dashboards Not Displaying Data**

   - **Symptoms**: Empty panels, errors loading dashboards.
   - **Solutions**:
     - Confirm that Prometheus is correctly set as a data source.
     - Check Grafana logs for data source connection issues.
     - Ensure that the relevant dashboards are correctly imported.

3. **Jaeger Not Collecting Traces**

   - **Symptoms**: Missing traces, Jaeger UI not showing trace data.
   - **Solutions**:
     - Verify that services are correctly instrumented for tracing.
     - Ensure that Jaeger collector is running and accessible.
     - Check Jaeger collector logs for errors.

4. **Alertmanager Not Receiving Alerts**

   - **Symptoms**: No notifications despite alerts being triggered.
   - **Solutions**:
     - Confirm that Prometheus is correctly configured to send alerts to Alertmanager.
     - Check Alertmanager logs for receipt of alerts.
     - Verify that notification receivers (e.g., Slack, email) are correctly configured.

5. **High Resource Consumption**

   - **Symptoms**: Monitoring pods consuming excessive CPU or memory.
   - **Solutions**:
     - Review resource requests and limits in deployment configurations.
     - Optimize Prometheus retention and scraping intervals.
     - Scale monitoring components as needed.

### Debugging Steps

1. **Check Pod Status and Logs**

   - Verify that all monitoring pods are running without errors.
     
     ```bash
     kubectl get pods -n monitoring
     kubectl logs <pod-name> -n monitoring
     ```

2. **Validate Configuration Files**

   - Ensure that all configuration files (Prometheus, Grafana, Jaeger, Alertmanager) are correctly defined and applied.
   
   ```bash
   kubectl get configmap prometheus-config -n monitoring -o yaml
   kubectl get configmap grafana-datasource -n monitoring -o yaml
   kubectl get configmap jaeger-collector-config -n monitoring -o yaml
   kubectl get configmap alertmanager-config -n monitoring -o yaml
   ```

3. **Use Helm Diagnostics**

   - If deployed via Helm, use Helm commands to inspect releases and retrieve status.
   
   ```bash
   helm list -n monitoring
   helm status prometheus -n monitoring
   helm status grafana -n monitoring
   helm status jaeger -n monitoring
   helm status alertmanager -n monitoring
   ```

4. **Test Connectivity**

   - Ensure that Prometheus can reach all configured targets.
   - Use port-forwarding to access Grafana and Jaeger UIs locally for testing.
   
   ```bash
   kubectl port-forward svc/prometheus-operated -n monitoring 9090:9090
   kubectl port-forward svc/grafana -n monitoring 3000:3000
   kubectl port-forward svc/jaeger-query -n monitoring 16686:16686
   kubectl port-forward svc/alertmanager -n monitoring 9093:9093
   ```

5. **Inspect Metrics and Logs**

   - Use Prometheus' web UI to query metrics and ensure they are being collected.
   - Check Grafana and Jaeger dashboards for real-time data visualization.
   - Review Alertmanager logs to confirm alert routing and notifications.

6. **Run Diagnostic Tools**

   - Utilize tools like `promtool` for Prometheus rule validation.
   
   ```bash
   promtool check config prometheus-config.yaml
   promtool check rules prometheus-rules.yaml
   ```

## Further Reading

- [Prometheus Documentation](https://prometheus.io/docs/introduction/overview/)
- [Grafana Documentation](https://grafana.com/docs/)
- [Jaeger Documentation](https://www.jaegertracing.io/docs/)
- [Alertmanager Documentation](https://prometheus.io/docs/alerting/latest/alertmanager/)
- [Kubernetes Monitoring with Prometheus](https://prometheus.io/docs/guides/kubernetes/)
- [Istio Observability](https://istio.io/latest/docs/ops/observability/)
- [Grafana Dashboards for Prometheus](https://grafana.com/docs/grafana/latest/dashboards/)
- [PromQL Query Language](https://prometheus.io/docs/prometheus/latest/querying/basics/)
- [Securing Prometheus](https://prometheus.io/docs/prometheus/latest/security/)
- [Kubernetes RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)

## Links

- [Root Documentation](../../README.md)
- [Prometheus Documentation](https://prometheus.io/docs/introduction/overview/)
- [Grafana Documentation](https://grafana.com/docs/)
- [Jaeger Documentation](https://www.jaegertracing.io/docs/)
- [Alertmanager Documentation](https://prometheus.io/docs/alerting/latest/alertmanager/)
- [Istio Observability Documentation](../../istio/README.md)
- [Kubernetes RBAC Documentation](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)


---

If you encounter any issues or have questions regarding the Kubernetes Monitoring Tools component, please refer to the [Troubleshooting](#troubleshooting) section or reach out to the project maintainers.